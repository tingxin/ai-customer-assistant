# 智能客服系统开发指南

## 项目概述

基于RAG技术的智能客服系统，使用阿里ChatUI + Python FastAPI + LightRAG构建。

**技术栈：**
- 前端：阿里ChatUI + React
- 后端：Python FastAPI
- 知识库：RAG-Anything + LightRAG
- 数据库：PostgreSQL + Redis

## 开发阶段规划

### 阶段1：前端聊天界面 (第1周)
- 前端环境配置
- ChatUI集成和定制
- 模拟数据测试
- 富文本回复渲染

### 阶段2：后端基础架构 (第2周)
- 后端API框架
- 数据库设计
- 基础会话管理
- 前后端联调

### 阶段3：核心对话功能 (第3-4周)
- 知识库集成(RAG)
- 智能问答功能
- 上下文管理

### 阶段4：高级功能 (第5-8周)
- 语音输入功能
- 提示词模板系统
- 管理后台
- 多渠道接入

---

# 第1周：前端聊天界面优先开发

## 1.1 快速环境搭建

### 创建项目结构
```bash
mkdir ai-customer-service
cd ai-customer-service

# 前端目录（优先）
mkdir frontend
cd frontend
```

### 前端环境配置
```bash
# 创建React TypeScript项目
npx create-react-app . --template typescript

# 安装ChatUI和相关依赖
npm install @chatui/core
npm install react-markdown react-syntax-highlighter
npm install remark-math rehype-katex
npm install @types/react-syntax-highlighter

# 安装开发工具
npm install --save-dev @types/node
```

## 1.2 模拟数据服务

### 创建模拟API服务
```typescript
// frontend/src/services/MockChatService.ts
export interface SessionResponse {
  session_id: string;
  expires_at: string;
}

export interface MessageResponse {
  content: string;
  message_id: string;
  timestamp: string;
}

// 模拟知识库数据
const mockKnowledge = {
  "产品功能": "我们的智能客服系统具有以下功能：\n\n1. **智能问答** - 基于知识库自动回答问题\n2. **多轮对话** - 支持上下文相关的连续对话\n3. **富文本回复** - 支持Markdown、表格、代码等格式\n4. **语音输入** - 支持语音转文字输入\n5. **实时监控** - 管理员可实时监控对话质量",
  
  "使用方法": "使用我们的智能客服非常简单：\n\n### 开始对话\n1. 直接在聊天窗口输入问题\n2. 点击发送或按回车键\n3. AI会立即为您提供回答\n\n### 高级功能\n- 🎤 点击麦克风图标使用语音输入\n- 📎 可以上传文件进行咨询\n- 💬 支持多轮连续对话",
  
  "技术支持": "遇到技术问题？我们来帮您解决：\n\n| 问题类型 | 解决方案 | 联系方式 |\n|---------|---------|---------||\n| 登录问题 | 清除浏览器缓存 | tech@example.com |\n| 功能异常 | 刷新页面重试 | 400-123-4567 |\n| 性能问题 | 检查网络连接 | 在线客服 |\n\n**工作时间：** 周一至周五 9:00-18:00",
  
  "常见问题": "## 常见问题解答\n\n**Q: 支持哪些浏览器？**\nA: 支持Chrome、Firefox、Safari、Edge等主流浏览器\n\n**Q: 数据安全吗？**\nA: 我们采用端到端加密，确保您的数据安全\n\n**Q: 可以集成到我的网站吗？**\nA: 可以，我们提供简单的JavaScript集成代码\n\n**Q: 支持移动端吗？**\nA: 完全支持，响应式设计适配所有设备"
};

// 简单的关键词匹配
function findBestMatch(message: string): string {
  const keywords = {
    "功能": "产品功能",
    "怎么用": "使用方法",
    "如何使用": "使用方法",
    "技术": "技术支持",
    "问题": "技术支持",
    "支持": "技术支持",
    "常见": "常见问题",
    "FAQ": "常见问题"
  };
  
  for (const [keyword, topic] of Object.entries(keywords)) {
    if (message.includes(keyword)) {
      return mockKnowledge[topic as keyof typeof mockKnowledge];
    }
  }
  
  return "感谢您的咨询！我是智能客服助手，可以为您介绍产品功能、使用方法，或解答技术问题。请告诉我您想了解什么？";
}

export class MockChatService {
  private static sessionId = 'mock-session-' + Date.now();
  
  static async initSession(): Promise<SessionResponse> {
    // 模拟网络延迟
    await new Promise(resolve => setTimeout(resolve, 500));
    
    return {
      session_id: this.sessionId,
      expires_at: new Date(Date.now() + 3600000).toISOString()
    };
  }

  static async sendMessage(sessionId: string, message: string): Promise<MessageResponse> {
    // 模拟网络延迟
    await new Promise(resolve => setTimeout(resolve, 800));
    
    const response = findBestMatch(message);
    
    return {
      content: response,
      message_id: 'msg-' + Date.now(),
      timestamp: new Date().toISOString()
    };
  }

  static async getSessionHistory(sessionId: string) {
    return {
      session_id: sessionId,
      messages: []
    };
  }
}
```

## 1.3 富文本渲染组件

### 创建富文本渲染器
```tsx
// frontend/src/components/RichTextRenderer.tsx
import React from 'react';
import ReactMarkdown from 'react-markdown';
import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';
import { tomorrow } from 'react-syntax-highlighter/dist/esm/styles/prism';
import remarkMath from 'remark-math';
import rehypeKatex from 'rehype-katex';
import 'katex/dist/katex.min.css';

interface RichTextRendererProps {
  content: string;
}

const RichTextRenderer: React.FC<RichTextRendererProps> = ({ content }) => {
  const components = {
    code({ node, inline, className, children, ...props }: any) {
      const match = /language-(\w+)/.exec(className || '');
      return !inline && match ? (
        <SyntaxHighlighter
          style={tomorrow}
          language={match[1]}
          PreTag="div"
          {...props}
        >
          {String(children).replace(/\n$/, '')}
        </SyntaxHighlighter>
      ) : (
        <code className={className} {...props}>
          {children}
        </code>
      );
    },
    
    table: ({ children }: any) => (
      <div className="table-container">
        <table className="rich-table">{children}</table>
      </div>
    ),
    
    a: ({ href, children }: any) => (
      <a 
        href={href} 
        target="_blank" 
        rel="noopener noreferrer"
        className="rich-link"
      >
        {children}
      </a>
    ),
    
    img: ({ src, alt }: any) => (
      <img 
        src={src} 
        alt={alt} 
        className="rich-image"
        loading="lazy"
      />
    )
  };

  return (
    <div className="rich-content">
      <ReactMarkdown
        components={components}
        remarkPlugins={[remarkMath]}
        rehypePlugins={[rehypeKatex]}
      >
        {content}
      </ReactMarkdown>
    </div>
  );
};

export default RichTextRenderer;
```

## 1.4 主应用组件

### 完整的App组件
```tsx
// frontend/src/App.tsx
import React, { useState, useEffect } from 'react';
import Chat, { Bubble, useMessages } from '@chatui/core';
import '@chatui/core/dist/index.css';
import { MockChatService } from './services/MockChatService';
import RichTextRenderer from './components/RichTextRenderer';
import './App.css';

const App: React.FC = () => {
  const { messages, appendMsg, setTyping } = useMessages([]);
  const [sessionId, setSessionId] = useState<string>('');

  useEffect(() => {
    initializeSession();
  }, []);

  const initializeSession = async () => {
    try {
      const session = await MockChatService.initSession();
      setSessionId(session.session_id);
      
      // 添加欢迎消息
      appendMsg({
        type: 'text',
        content: { text: '您好！我是智能客服助手 🤖\n\n我可以帮您：\n- 了解产品功能\n- 学习使用方法\n- 解决技术问题\n- 回答常见问题\n\n请告诉我您想了解什么？' },
        user: { avatar: '🤖' },
      });
    } catch (error) {
      console.error('Failed to initialize session:', error);
    }
  };

  const handleSend = async (type: string, val: string) => {
    if (type === 'text' && val.trim()) {
      // 添加用户消息
      appendMsg({
        type: 'text',
        content: { text: val },
        position: 'right',
      });

      setTyping(true);

      try {
        const response = await MockChatService.sendMessage(sessionId, val);
        
        // 添加AI回复
        appendMsg({
          type: 'text',
          content: { text: response.content },
          user: { avatar: '🤖' },
        });
      } catch (error) {
        appendMsg({
          type: 'text',
          content: { text: '抱歉，服务暂时不可用，请稍后再试。' },
          user: { avatar: '🤖' },
        });
      } finally {
        setTyping(false);
      }
    }
  };

  const renderMessageContent = (msg: any) => {
    const { content } = msg;
    
    // 如果是AI回复，使用富文本渲染
    if (msg.user?.avatar === '🤖') {
      return (
        <div className="ai-message">
          <RichTextRenderer content={content.text} />
        </div>
      );
    }
    
    return <Bubble content={content.text} />;
  };

  return (
    <div className="app-container">
      <Chat
        navbar={{ 
          title: '智能客服',
          rightContent: (
            <div className="navbar-info">
              <span className="status-indicator">● 在线</span>
            </div>
          )
        }}
        messages={messages}
        renderMessageContent={renderMessageContent}
        onSend={handleSend}
        placeholder="请输入您的问题..."
        quickReplies={[
          { name: '产品功能', isNew: true, isHighlight: false },
          { name: '使用方法', isNew: false, isHighlight: false },
          { name: '技术支持', isNew: false, isHighlight: false },
          { name: '常见问题', isNew: false, isHighlight: false },
        ]}
        onQuickReplyClick={(item) => handleSend('text', item.name)}
      />
    </div>
  );
};

export default App;
```

## 1.5 样式文件

### 创建样式
```css
/* frontend/src/App.css */
.app-container {
  height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.navbar-info {
  display: flex;
  align-items: center;
  font-size: 12px;
}

.status-indicator {
  color: #52c41a;
  font-weight: 500;
}

.ai-message {
  max-width: 100%;
}

.rich-content {
  line-height: 1.6;
  color: #333;
}

.rich-content h1, .rich-content h2, .rich-content h3 {
  margin: 16px 0 8px 0;
  font-weight: 600;
}

.rich-content h1 { font-size: 20px; }
.rich-content h2 { font-size: 18px; }
.rich-content h3 { font-size: 16px; }

.rich-content p {
  margin: 8px 0;
}

.rich-content ul, .rich-content ol {
  margin: 8px 0;
  padding-left: 20px;
}

.rich-content blockquote {
  margin: 12px 0;
  padding: 8px 12px;
  background: #f8f9fa;
  border-left: 3px solid #007bff;
  border-radius: 4px;
}

.rich-content code {
  background: #f1f3f4;
  padding: 2px 4px;
  border-radius: 3px;
  font-family: 'Monaco', 'Consolas', monospace;
  font-size: 0.9em;
}

.rich-content pre {
  background: #2d3748;
  padding: 12px;
  border-radius: 6px;
  overflow-x: auto;
  margin: 12px 0;
}

.rich-table {
  width: 100%;
  border-collapse: collapse;
  margin: 12px 0;
  font-size: 14px;
}

.rich-table th,
.rich-table td {
  border: 1px solid #e0e0e0;
  padding: 6px 10px;
  text-align: left;
}

.rich-table th {
  background: #f8f9fa;
  font-weight: 600;
}

.rich-link {
  color: #007bff;
  text-decoration: none;
}

.rich-link:hover {
  text-decoration: underline;
}

.rich-image {
  max-width: 100%;
  height: auto;
  border-radius: 6px;
  margin: 8px 0;
}

.table-container {
  overflow-x: auto;
}
```

## 1.6 启动和测试

### 启动前端应用
```bash
cd frontend
npm start
```

### 测试功能
1. 打开 http://localhost:3000
2. 测试以下对话：
   - "产品功能" - 查看功能介绍
   - "怎么用" - 查看使用方法
   - "技术问题" - 查看技术支持
   - "常见问题" - 查看FAQ
3. 测试快速回复按钮
4. 验证富文本渲染效果

---

# 第2周：后端API开发

## 2.1 环境搭建

### 创建后端目录结构
```bash
cd ai-customer-service
mkdir backend
cd backend

# 创建目录结构
mkdir app
mkdir app/api
mkdir app/api/routes
mkdir app/core
mkdir app/models
mkdir app/services
```

### Python环境配置
```bash
# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate  # Windows

# 安装基础依赖
pip install fastapi uvicorn
pip install sqlalchemy psycopg2-binary
pip install redis python-multipart
pip install pydantic-settings
```

## 2.2 基础配置

### 配置管理
```python
# backend/app/core/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # 数据库配置
    DATABASE_URL: str = "sqlite:///./ai_customer_service.db"  # 使用SQLite简化开发
    REDIS_URL: str = "redis://localhost:6379"
    
    # API配置
    SECRET_KEY: str = "your-secret-key-change-in-production"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30
    
    # AI配置
    OPENAI_API_KEY: str = ""
    MODEL_NAME: str = "gpt-3.5-turbo"
    
    class Config:
        env_file = ".env"

settings = Settings()
```

### 数据库模型
```python
# backend/app/models/database.py
from sqlalchemy import create_engine, Column, Integer, String, DateTime, Text
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from datetime import datetime
from app.core.config import settings

# 使用SQLite简化开发
engine = create_engine(
    settings.DATABASE_URL,
    connect_args={"check_same_thread": False}  # SQLite特有配置
)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

class Session(Base):
    __tablename__ = "sessions"
    
    id = Column(String, primary_key=True)
    user_id = Column(String, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    last_activity = Column(DateTime, default=datetime.utcnow)
    status = Column(String, default="active")

class Message(Base):
    __tablename__ = "messages"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    session_id = Column(String, nullable=False)
    sender = Column(String, nullable=False)  # user, ai, admin
    content = Column(Text, nullable=False)
    timestamp = Column(DateTime, default=datetime.utcnow)
    message_type = Column(String, default="text")

# 创建表
Base.metadata.create_all(bind=engine)

# 数据库依赖
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

## 2.3 基础API框架

### FastAPI主应用
```python
# backend/app/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.api.routes import chat

app = FastAPI(title="AI Customer Service", version="1.0.0")

# CORS配置
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# 路由注册
app.include_router(chat.router, prefix="/api/chat", tags=["chat"])

@app.get("/")
async def root():
    return {"message": "AI Customer Service API"}

@app.get("/health")
async def health_check():
    return {"status": "healthy"}
```

## 2.4 会话管理服务

### 会话服务
```python
# backend/app/services/session_service.py
from sqlalchemy.orm import Session
from app.models.database import Session as SessionModel, Message
from datetime import datetime
from typing import List, Optional

class SessionService:
    @staticmethod
    def create_session(db: Session, session_id: str, user_id: str) -> SessionModel:
        """创建新会话"""
        session = SessionModel(
            id=session_id,
            user_id=user_id,
            created_at=datetime.utcnow(),
            last_activity=datetime.utcnow()
        )
        db.add(session)
        db.commit()
        db.refresh(session)
        return session
    
    @staticmethod
    def get_session(db: Session, session_id: str) -> Optional[SessionModel]:
        """获取会话"""
        return db.query(SessionModel).filter(SessionModel.id == session_id).first()
    
    @staticmethod
    def save_message(db: Session, session_id: str, sender: str, content: str) -> Message:
        """保存消息"""
        message = Message(
            session_id=session_id,
            sender=sender,
            content=content,
            timestamp=datetime.utcnow()
        )
        db.add(message)
        db.commit()
        db.refresh(message)
        return message
    
    @staticmethod
    def get_session_messages(db: Session, session_id: str) -> List[Message]:
        """获取会话消息"""
        return db.query(Message).filter(
            Message.session_id == session_id
        ).order_by(Message.timestamp).all()
    
    @staticmethod
    def update_session_activity(db: Session, session_id: str):
        """更新会话活动时间"""
        session = db.query(SessionModel).filter(SessionModel.id == session_id).first()
        if session:
            session.last_activity = datetime.utcnow()
            db.commit()
```

### 简单聊天服务
```python
# backend/app/services/chat_service.py
import random
from typing import Dict

class ChatService:
    # 简单的规则匹配系统（后续会替换为RAG）
    KNOWLEDGE_BASE = {
        "功能": "我们的智能客服系统具有以下功能：\n\n1. **智能问答** - 基于知识库自动回答问题\n2. **多轮对话** - 支持上下文相关的连续对话\n3. **富文本回复** - 支持Markdown、表格、代码等格式\n4. **语音输入** - 支持语音转文字输入\n5. **实时监控** - 管理员可实时监控对话质量",
        
        "使用": "使用我们的智能客服非常简单：\n\n### 开始对话\n1. 直接在聊天窗口输入问题\n2. 点击发送或按回车键\n3. AI会立即为您提供回答\n\n### 高级功能\n- 🎤 点击麦克风图标使用语音输入\n- 📎 可以上传文件进行咨询\n- 💬 支持多轮连续对话",
        
        "技术": "遇到技术问题？我们来帮您解决：\n\n| 问题类型 | 解决方案 | 联系方式 |\n|---------|---------|---------||\n| 登录问题 | 清除浏览器缓存 | tech@example.com |\n| 功能异常 | 刷新页面重试 | 400-123-4567 |\n| 性能问题 | 检查网络连接 | 在线客服 |\n\n**工作时间：** 周一至周五 9:00-18:00",
        
        "常见": "## 常见问题解答\n\n**Q: 支持哪些浏览器？**\nA: 支持Chrome、Firefox、Safari、Edge等主流浏览器\n\n**Q: 数据安全吗？**\nA: 我们采用端到端加密，确保您的数据安全\n\n**Q: 可以集成到我的网站吗？**\nA: 可以，我们提供简单的JavaScript集成代码\n\n**Q: 支持移动端吗？**\nA: 完全支持，响应式设计适配所有设备"
    }
    
    @staticmethod
    async def generate_response(user_message: str, session_id: str) -> str:
        """生成AI回复"""
        try:
            # 简单的关键词匹配
            message_lower = user_message.lower()
            
            for keyword, response in ChatService.KNOWLEDGE_BASE.items():
                if keyword in message_lower:
                    return response
            
            # 默认回复
            default_responses = [
                "感谢您的咨询！我是智能客服助手，可以为您介绍产品功能、使用方法，或解答技术问题。请告诉我您想了解什么？",
                "您好！我可以帮您了解我们的产品功能、使用方法、技术支持或常见问题。请问您需要什么帮助？",
                "欢迎使用我们的智能客服！我可以回答关于产品功能、使用指南、技术支持等问题。请问有什么可以帮您的？"
            ]
            
            return random.choice(default_responses)
            
        except Exception as e:
            print(f"Error generating response: {e}")
            return "抱歉，我现在无法回答您的问题，请稍后再试。"
```

## 2.5 API路由

### 聊天API
```python
# backend/app/api/routes/chat.py
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from app.models.database import get_db
from app.services.session_service import SessionService
from app.services.chat_service import ChatService
from pydantic import BaseModel
import uuid

router = APIRouter()

class MessageRequest(BaseModel):
    session_id: str
    message: str

class MessageResponse(BaseModel):
    content: str
    message_id: str
    timestamp: str

@router.post("/session/init")
async def init_session(db: Session = Depends(get_db)):
    """初始化会话"""
    session_id = str(uuid.uuid4())
    user_id = str(uuid.uuid4())  # 临时用户ID
    
    session = SessionService.create_session(db, session_id, user_id)
    
    return {
        "session_id": session.id,
        "expires_at": session.created_at.isoformat()
    }

@router.post("/message", response_model=MessageResponse)
async def send_message(request: MessageRequest, db: Session = Depends(get_db)):
    """发送消息"""
    # 验证会话是否存在
    session = SessionService.get_session(db, request.session_id)
    if not session:
        raise HTTPException(status_code=404, detail="Session not found")
    
    # 保存用户消息
    user_message = SessionService.save_message(
        db, request.session_id, "user", request.message
    )
    
    # 生成AI回复
    ai_response = await ChatService.generate_response(request.message, request.session_id)
    
    # 保存AI回复
    ai_message = SessionService.save_message(
        db, request.session_id, "ai", ai_response
    )
    
    # 更新会话活动时间
    SessionService.update_session_activity(db, request.session_id)
    
    return MessageResponse(
        content=ai_response,
        message_id=str(ai_message.id),
        timestamp=ai_message.timestamp.isoformat()
    )

@router.get("/session/{session_id}/history")
async def get_session_history(session_id: str, db: Session = Depends(get_db)):
    """获取会话历史"""
    messages = SessionService.get_session_messages(db, session_id)
    return {
        "session_id": session_id,
        "messages": [
            {
                "id": msg.id,
                "sender": msg.sender,
                "content": msg.content,
                "timestamp": msg.timestamp.isoformat()
            }
            for msg in messages
        ]
    }
```

## 2.6 启动脚本

### 创建启动文件
```python
# backend/run.py
import uvicorn
from app.main import app

if __name__ == "__main__":
    uvicorn.run(
        "app.main:app",
        host="0.0.0.0",
        port=8000,
        reload=True,
        log_level="info"
    )
```

### 创建空文件
```bash
# 创建空的__init__.py文件
touch backend/app/__init__.py
touch backend/app/api/__init__.py
touch backend/app/api/routes/__init__.py
touch backend/app/core/__init__.py
touch backend/app/models/__init__.py
touch backend/app/services/__init__.py
```

## 2.7 前后端联调

### 更新前端服务
```typescript
// frontend/src/services/ChatService.ts
import axios from 'axios';

const API_BASE_URL = 'http://localhost:8000/api';

const apiClient = axios.create({
  baseURL: API_BASE_URL,
  timeout: 10000,
});

export interface SessionResponse {
  session_id: string;
  expires_at: string;
}

export interface MessageResponse {
  content: string;
  message_id: string;
  timestamp: string;
}

export class ChatService {
  static async initSession(): Promise<SessionResponse> {
    const response = await apiClient.post('/chat/session/init');
    return response.data;
  }

  static async sendMessage(sessionId: string, message: string): Promise<MessageResponse> {
    const response = await apiClient.post('/chat/message', {
      session_id: sessionId,
      message: message,
    });
    return response.data;
  }

  static async getSessionHistory(sessionId: string) {
    const response = await apiClient.get(`/chat/session/${sessionId}/history`);
    return response.data;
  }
}
```

### 更新App组件
```tsx
// frontend/src/App.tsx (更新部分)
// 将 MockChatService 替换为 ChatService
import { ChatService } from './services/ChatService';

// 在 initializeSession 和 handleSend 中使用 ChatService
const session = await ChatService.initSession();
const response = await ChatService.sendMessage(sessionId, val);
```

## 2.8 测试运行

### 启动后端
```bash
cd backend
source venv/bin/activate
python run.py
```

### 启动前端
```bash
cd frontend
npm start
```

### 测试功能
1. 访问 http://localhost:3000
2. 测试对话：
   - "产品功能"
   - "怎么使用"
   - "技术支持"
   - "常见问题"
3. 验证数据存储（查看 ai_customer_service.db 文件）

---

# 第3周预告：知识库集成

下周我们将：
1. 集成LightRAG知识库
2. 实现真正的智能问答
3. 添加知识库管理功能
4. 优化上下文管理