# æ™ºèƒ½å®¢æœç³»ç»Ÿå¼€å‘æŒ‡å—

## é¡¹ç›®æ¦‚è¿°

åŸºäºRAGæŠ€æœ¯çš„æ™ºèƒ½å®¢æœç³»ç»Ÿï¼Œä½¿ç”¨é˜¿é‡ŒChatUI + Python FastAPI + LightRAGæ„å»ºã€‚

**æŠ€æœ¯æ ˆï¼š**
- å‰ç«¯ï¼šé˜¿é‡ŒChatUI + React
- åç«¯ï¼šPython FastAPI
- çŸ¥è¯†åº“ï¼šRAG-Anything + LightRAG
- æ•°æ®åº“ï¼šPostgreSQL + Redis

## å¼€å‘é˜¶æ®µè§„åˆ’

### é˜¶æ®µ1ï¼šå‰ç«¯èŠå¤©ç•Œé¢ (ç¬¬1å‘¨)
- å‰ç«¯ç¯å¢ƒé…ç½®
- ChatUIé›†æˆå’Œå®šåˆ¶
- æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•
- å¯Œæ–‡æœ¬å›å¤æ¸²æŸ“

### é˜¶æ®µ2ï¼šåç«¯åŸºç¡€æ¶æ„ (ç¬¬2å‘¨)
- åç«¯APIæ¡†æ¶
- æ•°æ®åº“è®¾è®¡
- åŸºç¡€ä¼šè¯ç®¡ç†
- å‰åç«¯è”è°ƒ

### é˜¶æ®µ3ï¼šæ ¸å¿ƒå¯¹è¯åŠŸèƒ½ (ç¬¬3-4å‘¨)
- çŸ¥è¯†åº“é›†æˆ(RAG)
- æ™ºèƒ½é—®ç­”åŠŸèƒ½
- ä¸Šä¸‹æ–‡ç®¡ç†

### é˜¶æ®µ4ï¼šé«˜çº§åŠŸèƒ½ (ç¬¬5-8å‘¨)
- è¯­éŸ³è¾“å…¥åŠŸèƒ½
- æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿ
- ç®¡ç†åå°
- å¤šæ¸ é“æ¥å…¥

---

# ç¬¬1å‘¨ï¼šå‰ç«¯èŠå¤©ç•Œé¢ä¼˜å…ˆå¼€å‘

## 1.1 å¿«é€Ÿç¯å¢ƒæ­å»º

### åˆ›å»ºé¡¹ç›®ç»“æ„
```bash
mkdir ai-customer-service
cd ai-customer-service

# å‰ç«¯ç›®å½•ï¼ˆä¼˜å…ˆï¼‰
mkdir frontend
cd frontend
```

### å‰ç«¯ç¯å¢ƒé…ç½®
```bash
# åˆ›å»ºReact TypeScripté¡¹ç›®
npx create-react-app . --template typescript

# å®‰è£…ChatUIå’Œç›¸å…³ä¾èµ–
npm install @chatui/core
npm install react-markdown react-syntax-highlighter
npm install remark-math rehype-katex
npm install @types/react-syntax-highlighter

# å®‰è£…å¼€å‘å·¥å…·
npm install --save-dev @types/node
```

## 1.2 æ¨¡æ‹Ÿæ•°æ®æœåŠ¡

### åˆ›å»ºæ¨¡æ‹ŸAPIæœåŠ¡
```typescript
// frontend/src/services/MockChatService.ts
export interface SessionResponse {
  session_id: string;
  expires_at: string;
}

export interface MessageResponse {
  content: string;
  message_id: string;
  timestamp: string;
}

// æ¨¡æ‹ŸçŸ¥è¯†åº“æ•°æ®
const mockKnowledge = {
  "äº§å“åŠŸèƒ½": "æˆ‘ä»¬çš„æ™ºèƒ½å®¢æœç³»ç»Ÿå…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š\n\n1. **æ™ºèƒ½é—®ç­”** - åŸºäºçŸ¥è¯†åº“è‡ªåŠ¨å›ç­”é—®é¢˜\n2. **å¤šè½®å¯¹è¯** - æ”¯æŒä¸Šä¸‹æ–‡ç›¸å…³çš„è¿ç»­å¯¹è¯\n3. **å¯Œæ–‡æœ¬å›å¤** - æ”¯æŒMarkdownã€è¡¨æ ¼ã€ä»£ç ç­‰æ ¼å¼\n4. **è¯­éŸ³è¾“å…¥** - æ”¯æŒè¯­éŸ³è½¬æ–‡å­—è¾“å…¥\n5. **å®æ—¶ç›‘æ§** - ç®¡ç†å‘˜å¯å®æ—¶ç›‘æ§å¯¹è¯è´¨é‡",
  
  "ä½¿ç”¨æ–¹æ³•": "ä½¿ç”¨æˆ‘ä»¬çš„æ™ºèƒ½å®¢æœéå¸¸ç®€å•ï¼š\n\n### å¼€å§‹å¯¹è¯\n1. ç›´æ¥åœ¨èŠå¤©çª—å£è¾“å…¥é—®é¢˜\n2. ç‚¹å‡»å‘é€æˆ–æŒ‰å›è½¦é”®\n3. AIä¼šç«‹å³ä¸ºæ‚¨æä¾›å›ç­”\n\n### é«˜çº§åŠŸèƒ½\n- ğŸ¤ ç‚¹å‡»éº¦å…‹é£å›¾æ ‡ä½¿ç”¨è¯­éŸ³è¾“å…¥\n- ğŸ“ å¯ä»¥ä¸Šä¼ æ–‡ä»¶è¿›è¡Œå’¨è¯¢\n- ğŸ’¬ æ”¯æŒå¤šè½®è¿ç»­å¯¹è¯",
  
  "æŠ€æœ¯æ”¯æŒ": "é‡åˆ°æŠ€æœ¯é—®é¢˜ï¼Ÿæˆ‘ä»¬æ¥å¸®æ‚¨è§£å†³ï¼š\n\n| é—®é¢˜ç±»å‹ | è§£å†³æ–¹æ¡ˆ | è”ç³»æ–¹å¼ |\n|---------|---------|---------||\n| ç™»å½•é—®é¢˜ | æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ | tech@example.com |\n| åŠŸèƒ½å¼‚å¸¸ | åˆ·æ–°é¡µé¢é‡è¯• | 400-123-4567 |\n| æ€§èƒ½é—®é¢˜ | æ£€æŸ¥ç½‘ç»œè¿æ¥ | åœ¨çº¿å®¢æœ |\n\n**å·¥ä½œæ—¶é—´ï¼š** å‘¨ä¸€è‡³å‘¨äº” 9:00-18:00",
  
  "å¸¸è§é—®é¢˜": "## å¸¸è§é—®é¢˜è§£ç­”\n\n**Q: æ”¯æŒå“ªäº›æµè§ˆå™¨ï¼Ÿ**\nA: æ”¯æŒChromeã€Firefoxã€Safariã€Edgeç­‰ä¸»æµæµè§ˆå™¨\n\n**Q: æ•°æ®å®‰å…¨å—ï¼Ÿ**\nA: æˆ‘ä»¬é‡‡ç”¨ç«¯åˆ°ç«¯åŠ å¯†ï¼Œç¡®ä¿æ‚¨çš„æ•°æ®å®‰å…¨\n\n**Q: å¯ä»¥é›†æˆåˆ°æˆ‘çš„ç½‘ç«™å—ï¼Ÿ**\nA: å¯ä»¥ï¼Œæˆ‘ä»¬æä¾›ç®€å•çš„JavaScripté›†æˆä»£ç \n\n**Q: æ”¯æŒç§»åŠ¨ç«¯å—ï¼Ÿ**\nA: å®Œå…¨æ”¯æŒï¼Œå“åº”å¼è®¾è®¡é€‚é…æ‰€æœ‰è®¾å¤‡"
};

// ç®€å•çš„å…³é”®è¯åŒ¹é…
function findBestMatch(message: string): string {
  const keywords = {
    "åŠŸèƒ½": "äº§å“åŠŸèƒ½",
    "æ€ä¹ˆç”¨": "ä½¿ç”¨æ–¹æ³•",
    "å¦‚ä½•ä½¿ç”¨": "ä½¿ç”¨æ–¹æ³•",
    "æŠ€æœ¯": "æŠ€æœ¯æ”¯æŒ",
    "é—®é¢˜": "æŠ€æœ¯æ”¯æŒ",
    "æ”¯æŒ": "æŠ€æœ¯æ”¯æŒ",
    "å¸¸è§": "å¸¸è§é—®é¢˜",
    "FAQ": "å¸¸è§é—®é¢˜"
  };
  
  for (const [keyword, topic] of Object.entries(keywords)) {
    if (message.includes(keyword)) {
      return mockKnowledge[topic as keyof typeof mockKnowledge];
    }
  }
  
  return "æ„Ÿè°¢æ‚¨çš„å’¨è¯¢ï¼æˆ‘æ˜¯æ™ºèƒ½å®¢æœåŠ©æ‰‹ï¼Œå¯ä»¥ä¸ºæ‚¨ä»‹ç»äº§å“åŠŸèƒ½ã€ä½¿ç”¨æ–¹æ³•ï¼Œæˆ–è§£ç­”æŠ€æœ¯é—®é¢˜ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ";
}

export class MockChatService {
  private static sessionId = 'mock-session-' + Date.now();
  
  static async initSession(): Promise<SessionResponse> {
    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    await new Promise(resolve => setTimeout(resolve, 500));
    
    return {
      session_id: this.sessionId,
      expires_at: new Date(Date.now() + 3600000).toISOString()
    };
  }

  static async sendMessage(sessionId: string, message: string): Promise<MessageResponse> {
    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    await new Promise(resolve => setTimeout(resolve, 800));
    
    const response = findBestMatch(message);
    
    return {
      content: response,
      message_id: 'msg-' + Date.now(),
      timestamp: new Date().toISOString()
    };
  }

  static async getSessionHistory(sessionId: string) {
    return {
      session_id: sessionId,
      messages: []
    };
  }
}
```

## 1.3 å¯Œæ–‡æœ¬æ¸²æŸ“ç»„ä»¶

### åˆ›å»ºå¯Œæ–‡æœ¬æ¸²æŸ“å™¨
```tsx
// frontend/src/components/RichTextRenderer.tsx
import React from 'react';
import ReactMarkdown from 'react-markdown';
import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';
import { tomorrow } from 'react-syntax-highlighter/dist/esm/styles/prism';
import remarkMath from 'remark-math';
import rehypeKatex from 'rehype-katex';
import 'katex/dist/katex.min.css';

interface RichTextRendererProps {
  content: string;
}

const RichTextRenderer: React.FC<RichTextRendererProps> = ({ content }) => {
  const components = {
    code({ node, inline, className, children, ...props }: any) {
      const match = /language-(\w+)/.exec(className || '');
      return !inline && match ? (
        <SyntaxHighlighter
          style={tomorrow}
          language={match[1]}
          PreTag="div"
          {...props}
        >
          {String(children).replace(/\n$/, '')}
        </SyntaxHighlighter>
      ) : (
        <code className={className} {...props}>
          {children}
        </code>
      );
    },
    
    table: ({ children }: any) => (
      <div className="table-container">
        <table className="rich-table">{children}</table>
      </div>
    ),
    
    a: ({ href, children }: any) => (
      <a 
        href={href} 
        target="_blank" 
        rel="noopener noreferrer"
        className="rich-link"
      >
        {children}
      </a>
    ),
    
    img: ({ src, alt }: any) => (
      <img 
        src={src} 
        alt={alt} 
        className="rich-image"
        loading="lazy"
      />
    )
  };

  return (
    <div className="rich-content">
      <ReactMarkdown
        components={components}
        remarkPlugins={[remarkMath]}
        rehypePlugins={[rehypeKatex]}
      >
        {content}
      </ReactMarkdown>
    </div>
  );
};

export default RichTextRenderer;
```

## 1.4 ä¸»åº”ç”¨ç»„ä»¶

### å®Œæ•´çš„Appç»„ä»¶
```tsx
// frontend/src/App.tsx
import React, { useState, useEffect } from 'react';
import Chat, { Bubble, useMessages } from '@chatui/core';
import '@chatui/core/dist/index.css';
import { MockChatService } from './services/MockChatService';
import RichTextRenderer from './components/RichTextRenderer';
import './App.css';

const App: React.FC = () => {
  const { messages, appendMsg, setTyping } = useMessages([]);
  const [sessionId, setSessionId] = useState<string>('');

  useEffect(() => {
    initializeSession();
  }, []);

  const initializeSession = async () => {
    try {
      const session = await MockChatService.initSession();
      setSessionId(session.session_id);
      
      // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
      appendMsg({
        type: 'text',
        content: { text: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½å®¢æœåŠ©æ‰‹ ğŸ¤–\n\næˆ‘å¯ä»¥å¸®æ‚¨ï¼š\n- äº†è§£äº§å“åŠŸèƒ½\n- å­¦ä¹ ä½¿ç”¨æ–¹æ³•\n- è§£å†³æŠ€æœ¯é—®é¢˜\n- å›ç­”å¸¸è§é—®é¢˜\n\nè¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ' },
        user: { avatar: 'ğŸ¤–' },
      });
    } catch (error) {
      console.error('Failed to initialize session:', error);
    }
  };

  const handleSend = async (type: string, val: string) => {
    if (type === 'text' && val.trim()) {
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      appendMsg({
        type: 'text',
        content: { text: val },
        position: 'right',
      });

      setTyping(true);

      try {
        const response = await MockChatService.sendMessage(sessionId, val);
        
        // æ·»åŠ AIå›å¤
        appendMsg({
          type: 'text',
          content: { text: response.content },
          user: { avatar: 'ğŸ¤–' },
        });
      } catch (error) {
        appendMsg({
          type: 'text',
          content: { text: 'æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚' },
          user: { avatar: 'ğŸ¤–' },
        });
      } finally {
        setTyping(false);
      }
    }
  };

  const renderMessageContent = (msg: any) => {
    const { content } = msg;
    
    // å¦‚æœæ˜¯AIå›å¤ï¼Œä½¿ç”¨å¯Œæ–‡æœ¬æ¸²æŸ“
    if (msg.user?.avatar === 'ğŸ¤–') {
      return (
        <div className="ai-message">
          <RichTextRenderer content={content.text} />
        </div>
      );
    }
    
    return <Bubble content={content.text} />;
  };

  return (
    <div className="app-container">
      <Chat
        navbar={{ 
          title: 'æ™ºèƒ½å®¢æœ',
          rightContent: (
            <div className="navbar-info">
              <span className="status-indicator">â— åœ¨çº¿</span>
            </div>
          )
        }}
        messages={messages}
        renderMessageContent={renderMessageContent}
        onSend={handleSend}
        placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
        quickReplies={[
          { name: 'äº§å“åŠŸèƒ½', isNew: true, isHighlight: false },
          { name: 'ä½¿ç”¨æ–¹æ³•', isNew: false, isHighlight: false },
          { name: 'æŠ€æœ¯æ”¯æŒ', isNew: false, isHighlight: false },
          { name: 'å¸¸è§é—®é¢˜', isNew: false, isHighlight: false },
        ]}
        onQuickReplyClick={(item) => handleSend('text', item.name)}
      />
    </div>
  );
};

export default App;
```

## 1.5 æ ·å¼æ–‡ä»¶

### åˆ›å»ºæ ·å¼
```css
/* frontend/src/App.css */
.app-container {
  height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.navbar-info {
  display: flex;
  align-items: center;
  font-size: 12px;
}

.status-indicator {
  color: #52c41a;
  font-weight: 500;
}

.ai-message {
  max-width: 100%;
}

.rich-content {
  line-height: 1.6;
  color: #333;
}

.rich-content h1, .rich-content h2, .rich-content h3 {
  margin: 16px 0 8px 0;
  font-weight: 600;
}

.rich-content h1 { font-size: 20px; }
.rich-content h2 { font-size: 18px; }
.rich-content h3 { font-size: 16px; }

.rich-content p {
  margin: 8px 0;
}

.rich-content ul, .rich-content ol {
  margin: 8px 0;
  padding-left: 20px;
}

.rich-content blockquote {
  margin: 12px 0;
  padding: 8px 12px;
  background: #f8f9fa;
  border-left: 3px solid #007bff;
  border-radius: 4px;
}

.rich-content code {
  background: #f1f3f4;
  padding: 2px 4px;
  border-radius: 3px;
  font-family: 'Monaco', 'Consolas', monospace;
  font-size: 0.9em;
}

.rich-content pre {
  background: #2d3748;
  padding: 12px;
  border-radius: 6px;
  overflow-x: auto;
  margin: 12px 0;
}

.rich-table {
  width: 100%;
  border-collapse: collapse;
  margin: 12px 0;
  font-size: 14px;
}

.rich-table th,
.rich-table td {
  border: 1px solid #e0e0e0;
  padding: 6px 10px;
  text-align: left;
}

.rich-table th {
  background: #f8f9fa;
  font-weight: 600;
}

.rich-link {
  color: #007bff;
  text-decoration: none;
}

.rich-link:hover {
  text-decoration: underline;
}

.rich-image {
  max-width: 100%;
  height: auto;
  border-radius: 6px;
  margin: 8px 0;
}

.table-container {
  overflow-x: auto;
}
```

## 1.6 å¯åŠ¨å’Œæµ‹è¯•

### å¯åŠ¨å‰ç«¯åº”ç”¨
```bash
cd frontend
npm start
```

### æµ‹è¯•åŠŸèƒ½
1. æ‰“å¼€ http://localhost:3000
2. æµ‹è¯•ä»¥ä¸‹å¯¹è¯ï¼š
   - "äº§å“åŠŸèƒ½" - æŸ¥çœ‹åŠŸèƒ½ä»‹ç»
   - "æ€ä¹ˆç”¨" - æŸ¥çœ‹ä½¿ç”¨æ–¹æ³•
   - "æŠ€æœ¯é—®é¢˜" - æŸ¥çœ‹æŠ€æœ¯æ”¯æŒ
   - "å¸¸è§é—®é¢˜" - æŸ¥çœ‹FAQ
3. æµ‹è¯•å¿«é€Ÿå›å¤æŒ‰é’®
4. éªŒè¯å¯Œæ–‡æœ¬æ¸²æŸ“æ•ˆæœ

---

# ç¬¬2å‘¨ï¼šåç«¯APIå¼€å‘

## 2.1 ç¯å¢ƒæ­å»º

### åˆ›å»ºåç«¯ç›®å½•ç»“æ„
```bash
cd ai-customer-service
mkdir backend
cd backend

# åˆ›å»ºç›®å½•ç»“æ„
mkdir app
mkdir app/api
mkdir app/api/routes
mkdir app/core
mkdir app/models
mkdir app/services
```

### Pythonç¯å¢ƒé…ç½®
```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate  # Windows

# å®‰è£…åŸºç¡€ä¾èµ–
pip install fastapi uvicorn
pip install sqlalchemy psycopg2-binary
pip install redis python-multipart
pip install pydantic-settings
```

## 2.2 åŸºç¡€é…ç½®

### é…ç½®ç®¡ç†
```python
# backend/app/core/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # æ•°æ®åº“é…ç½®
    DATABASE_URL: str = "sqlite:///./ai_customer_service.db"  # ä½¿ç”¨SQLiteç®€åŒ–å¼€å‘
    REDIS_URL: str = "redis://localhost:6379"
    
    # APIé…ç½®
    SECRET_KEY: str = "your-secret-key-change-in-production"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30
    
    # AIé…ç½®
    OPENAI_API_KEY: str = ""
    MODEL_NAME: str = "gpt-3.5-turbo"
    
    class Config:
        env_file = ".env"

settings = Settings()
```

### æ•°æ®åº“æ¨¡å‹
```python
# backend/app/models/database.py
from sqlalchemy import create_engine, Column, Integer, String, DateTime, Text
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from datetime import datetime
from app.core.config import settings

# ä½¿ç”¨SQLiteç®€åŒ–å¼€å‘
engine = create_engine(
    settings.DATABASE_URL,
    connect_args={"check_same_thread": False}  # SQLiteç‰¹æœ‰é…ç½®
)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

class Session(Base):
    __tablename__ = "sessions"
    
    id = Column(String, primary_key=True)
    user_id = Column(String, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    last_activity = Column(DateTime, default=datetime.utcnow)
    status = Column(String, default="active")

class Message(Base):
    __tablename__ = "messages"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    session_id = Column(String, nullable=False)
    sender = Column(String, nullable=False)  # user, ai, admin
    content = Column(Text, nullable=False)
    timestamp = Column(DateTime, default=datetime.utcnow)
    message_type = Column(String, default="text")

# åˆ›å»ºè¡¨
Base.metadata.create_all(bind=engine)

# æ•°æ®åº“ä¾èµ–
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

## 2.3 åŸºç¡€APIæ¡†æ¶

### FastAPIä¸»åº”ç”¨
```python
# backend/app/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.api.routes import chat

app = FastAPI(title="AI Customer Service", version="1.0.0")

# CORSé…ç½®
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# è·¯ç”±æ³¨å†Œ
app.include_router(chat.router, prefix="/api/chat", tags=["chat"])

@app.get("/")
async def root():
    return {"message": "AI Customer Service API"}

@app.get("/health")
async def health_check():
    return {"status": "healthy"}
```

## 2.4 ä¼šè¯ç®¡ç†æœåŠ¡

### ä¼šè¯æœåŠ¡
```python
# backend/app/services/session_service.py
from sqlalchemy.orm import Session
from app.models.database import Session as SessionModel, Message
from datetime import datetime
from typing import List, Optional

class SessionService:
    @staticmethod
    def create_session(db: Session, session_id: str, user_id: str) -> SessionModel:
        """åˆ›å»ºæ–°ä¼šè¯"""
        session = SessionModel(
            id=session_id,
            user_id=user_id,
            created_at=datetime.utcnow(),
            last_activity=datetime.utcnow()
        )
        db.add(session)
        db.commit()
        db.refresh(session)
        return session
    
    @staticmethod
    def get_session(db: Session, session_id: str) -> Optional[SessionModel]:
        """è·å–ä¼šè¯"""
        return db.query(SessionModel).filter(SessionModel.id == session_id).first()
    
    @staticmethod
    def save_message(db: Session, session_id: str, sender: str, content: str) -> Message:
        """ä¿å­˜æ¶ˆæ¯"""
        message = Message(
            session_id=session_id,
            sender=sender,
            content=content,
            timestamp=datetime.utcnow()
        )
        db.add(message)
        db.commit()
        db.refresh(message)
        return message
    
    @staticmethod
    def get_session_messages(db: Session, session_id: str) -> List[Message]:
        """è·å–ä¼šè¯æ¶ˆæ¯"""
        return db.query(Message).filter(
            Message.session_id == session_id
        ).order_by(Message.timestamp).all()
    
    @staticmethod
    def update_session_activity(db: Session, session_id: str):
        """æ›´æ–°ä¼šè¯æ´»åŠ¨æ—¶é—´"""
        session = db.query(SessionModel).filter(SessionModel.id == session_id).first()
        if session:
            session.last_activity = datetime.utcnow()
            db.commit()
```

### ç®€å•èŠå¤©æœåŠ¡
```python
# backend/app/services/chat_service.py
import random
from typing import Dict

class ChatService:
    # ç®€å•çš„è§„åˆ™åŒ¹é…ç³»ç»Ÿï¼ˆåç»­ä¼šæ›¿æ¢ä¸ºRAGï¼‰
    KNOWLEDGE_BASE = {
        "åŠŸèƒ½": "æˆ‘ä»¬çš„æ™ºèƒ½å®¢æœç³»ç»Ÿå…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š\n\n1. **æ™ºèƒ½é—®ç­”** - åŸºäºçŸ¥è¯†åº“è‡ªåŠ¨å›ç­”é—®é¢˜\n2. **å¤šè½®å¯¹è¯** - æ”¯æŒä¸Šä¸‹æ–‡ç›¸å…³çš„è¿ç»­å¯¹è¯\n3. **å¯Œæ–‡æœ¬å›å¤** - æ”¯æŒMarkdownã€è¡¨æ ¼ã€ä»£ç ç­‰æ ¼å¼\n4. **è¯­éŸ³è¾“å…¥** - æ”¯æŒè¯­éŸ³è½¬æ–‡å­—è¾“å…¥\n5. **å®æ—¶ç›‘æ§** - ç®¡ç†å‘˜å¯å®æ—¶ç›‘æ§å¯¹è¯è´¨é‡",
        
        "ä½¿ç”¨": "ä½¿ç”¨æˆ‘ä»¬çš„æ™ºèƒ½å®¢æœéå¸¸ç®€å•ï¼š\n\n### å¼€å§‹å¯¹è¯\n1. ç›´æ¥åœ¨èŠå¤©çª—å£è¾“å…¥é—®é¢˜\n2. ç‚¹å‡»å‘é€æˆ–æŒ‰å›è½¦é”®\n3. AIä¼šç«‹å³ä¸ºæ‚¨æä¾›å›ç­”\n\n### é«˜çº§åŠŸèƒ½\n- ğŸ¤ ç‚¹å‡»éº¦å…‹é£å›¾æ ‡ä½¿ç”¨è¯­éŸ³è¾“å…¥\n- ğŸ“ å¯ä»¥ä¸Šä¼ æ–‡ä»¶è¿›è¡Œå’¨è¯¢\n- ğŸ’¬ æ”¯æŒå¤šè½®è¿ç»­å¯¹è¯",
        
        "æŠ€æœ¯": "é‡åˆ°æŠ€æœ¯é—®é¢˜ï¼Ÿæˆ‘ä»¬æ¥å¸®æ‚¨è§£å†³ï¼š\n\n| é—®é¢˜ç±»å‹ | è§£å†³æ–¹æ¡ˆ | è”ç³»æ–¹å¼ |\n|---------|---------|---------||\n| ç™»å½•é—®é¢˜ | æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ | tech@example.com |\n| åŠŸèƒ½å¼‚å¸¸ | åˆ·æ–°é¡µé¢é‡è¯• | 400-123-4567 |\n| æ€§èƒ½é—®é¢˜ | æ£€æŸ¥ç½‘ç»œè¿æ¥ | åœ¨çº¿å®¢æœ |\n\n**å·¥ä½œæ—¶é—´ï¼š** å‘¨ä¸€è‡³å‘¨äº” 9:00-18:00",
        
        "å¸¸è§": "## å¸¸è§é—®é¢˜è§£ç­”\n\n**Q: æ”¯æŒå“ªäº›æµè§ˆå™¨ï¼Ÿ**\nA: æ”¯æŒChromeã€Firefoxã€Safariã€Edgeç­‰ä¸»æµæµè§ˆå™¨\n\n**Q: æ•°æ®å®‰å…¨å—ï¼Ÿ**\nA: æˆ‘ä»¬é‡‡ç”¨ç«¯åˆ°ç«¯åŠ å¯†ï¼Œç¡®ä¿æ‚¨çš„æ•°æ®å®‰å…¨\n\n**Q: å¯ä»¥é›†æˆåˆ°æˆ‘çš„ç½‘ç«™å—ï¼Ÿ**\nA: å¯ä»¥ï¼Œæˆ‘ä»¬æä¾›ç®€å•çš„JavaScripté›†æˆä»£ç \n\n**Q: æ”¯æŒç§»åŠ¨ç«¯å—ï¼Ÿ**\nA: å®Œå…¨æ”¯æŒï¼Œå“åº”å¼è®¾è®¡é€‚é…æ‰€æœ‰è®¾å¤‡"
    }
    
    @staticmethod
    async def generate_response(user_message: str, session_id: str) -> str:
        """ç”ŸæˆAIå›å¤"""
        try:
            # ç®€å•çš„å…³é”®è¯åŒ¹é…
            message_lower = user_message.lower()
            
            for keyword, response in ChatService.KNOWLEDGE_BASE.items():
                if keyword in message_lower:
                    return response
            
            # é»˜è®¤å›å¤
            default_responses = [
                "æ„Ÿè°¢æ‚¨çš„å’¨è¯¢ï¼æˆ‘æ˜¯æ™ºèƒ½å®¢æœåŠ©æ‰‹ï¼Œå¯ä»¥ä¸ºæ‚¨ä»‹ç»äº§å“åŠŸèƒ½ã€ä½¿ç”¨æ–¹æ³•ï¼Œæˆ–è§£ç­”æŠ€æœ¯é—®é¢˜ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ",
                "æ‚¨å¥½ï¼æˆ‘å¯ä»¥å¸®æ‚¨äº†è§£æˆ‘ä»¬çš„äº§å“åŠŸèƒ½ã€ä½¿ç”¨æ–¹æ³•ã€æŠ€æœ¯æ”¯æŒæˆ–å¸¸è§é—®é¢˜ã€‚è¯·é—®æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ",
                "æ¬¢è¿ä½¿ç”¨æˆ‘ä»¬çš„æ™ºèƒ½å®¢æœï¼æˆ‘å¯ä»¥å›ç­”å…³äºäº§å“åŠŸèƒ½ã€ä½¿ç”¨æŒ‡å—ã€æŠ€æœ¯æ”¯æŒç­‰é—®é¢˜ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„ï¼Ÿ"
            ]
            
            return random.choice(default_responses)
            
        except Exception as e:
            print(f"Error generating response: {e}")
            return "æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚"
```

## 2.5 APIè·¯ç”±

### èŠå¤©API
```python
# backend/app/api/routes/chat.py
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from app.models.database import get_db
from app.services.session_service import SessionService
from app.services.chat_service import ChatService
from pydantic import BaseModel
import uuid

router = APIRouter()

class MessageRequest(BaseModel):
    session_id: str
    message: str

class MessageResponse(BaseModel):
    content: str
    message_id: str
    timestamp: str

@router.post("/session/init")
async def init_session(db: Session = Depends(get_db)):
    """åˆå§‹åŒ–ä¼šè¯"""
    session_id = str(uuid.uuid4())
    user_id = str(uuid.uuid4())  # ä¸´æ—¶ç”¨æˆ·ID
    
    session = SessionService.create_session(db, session_id, user_id)
    
    return {
        "session_id": session.id,
        "expires_at": session.created_at.isoformat()
    }

@router.post("/message", response_model=MessageResponse)
async def send_message(request: MessageRequest, db: Session = Depends(get_db)):
    """å‘é€æ¶ˆæ¯"""
    # éªŒè¯ä¼šè¯æ˜¯å¦å­˜åœ¨
    session = SessionService.get_session(db, request.session_id)
    if not session:
        raise HTTPException(status_code=404, detail="Session not found")
    
    # ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
    user_message = SessionService.save_message(
        db, request.session_id, "user", request.message
    )
    
    # ç”ŸæˆAIå›å¤
    ai_response = await ChatService.generate_response(request.message, request.session_id)
    
    # ä¿å­˜AIå›å¤
    ai_message = SessionService.save_message(
        db, request.session_id, "ai", ai_response
    )
    
    # æ›´æ–°ä¼šè¯æ´»åŠ¨æ—¶é—´
    SessionService.update_session_activity(db, request.session_id)
    
    return MessageResponse(
        content=ai_response,
        message_id=str(ai_message.id),
        timestamp=ai_message.timestamp.isoformat()
    )

@router.get("/session/{session_id}/history")
async def get_session_history(session_id: str, db: Session = Depends(get_db)):
    """è·å–ä¼šè¯å†å²"""
    messages = SessionService.get_session_messages(db, session_id)
    return {
        "session_id": session_id,
        "messages": [
            {
                "id": msg.id,
                "sender": msg.sender,
                "content": msg.content,
                "timestamp": msg.timestamp.isoformat()
            }
            for msg in messages
        ]
    }
```

## 2.6 å¯åŠ¨è„šæœ¬

### åˆ›å»ºå¯åŠ¨æ–‡ä»¶
```python
# backend/run.py
import uvicorn
from app.main import app

if __name__ == "__main__":
    uvicorn.run(
        "app.main:app",
        host="0.0.0.0",
        port=8000,
        reload=True,
        log_level="info"
    )
```

### åˆ›å»ºç©ºæ–‡ä»¶
```bash
# åˆ›å»ºç©ºçš„__init__.pyæ–‡ä»¶
touch backend/app/__init__.py
touch backend/app/api/__init__.py
touch backend/app/api/routes/__init__.py
touch backend/app/core/__init__.py
touch backend/app/models/__init__.py
touch backend/app/services/__init__.py
```

## 2.7 å‰åç«¯è”è°ƒ

### æ›´æ–°å‰ç«¯æœåŠ¡
```typescript
// frontend/src/services/ChatService.ts
import axios from 'axios';

const API_BASE_URL = 'http://localhost:8000/api';

const apiClient = axios.create({
  baseURL: API_BASE_URL,
  timeout: 10000,
});

export interface SessionResponse {
  session_id: string;
  expires_at: string;
}

export interface MessageResponse {
  content: string;
  message_id: string;
  timestamp: string;
}

export class ChatService {
  static async initSession(): Promise<SessionResponse> {
    const response = await apiClient.post('/chat/session/init');
    return response.data;
  }

  static async sendMessage(sessionId: string, message: string): Promise<MessageResponse> {
    const response = await apiClient.post('/chat/message', {
      session_id: sessionId,
      message: message,
    });
    return response.data;
  }

  static async getSessionHistory(sessionId: string) {
    const response = await apiClient.get(`/chat/session/${sessionId}/history`);
    return response.data;
  }
}
```

### æ›´æ–°Appç»„ä»¶
```tsx
// frontend/src/App.tsx (æ›´æ–°éƒ¨åˆ†)
// å°† MockChatService æ›¿æ¢ä¸º ChatService
import { ChatService } from './services/ChatService';

// åœ¨ initializeSession å’Œ handleSend ä¸­ä½¿ç”¨ ChatService
const session = await ChatService.initSession();
const response = await ChatService.sendMessage(sessionId, val);
```

## 2.8 æµ‹è¯•è¿è¡Œ

### å¯åŠ¨åç«¯
```bash
cd backend
source venv/bin/activate
python run.py
```

### å¯åŠ¨å‰ç«¯
```bash
cd frontend
npm start
```

### æµ‹è¯•åŠŸèƒ½
1. è®¿é—® http://localhost:3000
2. æµ‹è¯•å¯¹è¯ï¼š
   - "äº§å“åŠŸèƒ½"
   - "æ€ä¹ˆä½¿ç”¨"
   - "æŠ€æœ¯æ”¯æŒ"
   - "å¸¸è§é—®é¢˜"
3. éªŒè¯æ•°æ®å­˜å‚¨ï¼ˆæŸ¥çœ‹ ai_customer_service.db æ–‡ä»¶ï¼‰

---

# ç¬¬3å‘¨é¢„å‘Šï¼šçŸ¥è¯†åº“é›†æˆ

ä¸‹å‘¨æˆ‘ä»¬å°†ï¼š
1. é›†æˆLightRAGçŸ¥è¯†åº“
2. å®ç°çœŸæ­£çš„æ™ºèƒ½é—®ç­”
3. æ·»åŠ çŸ¥è¯†åº“ç®¡ç†åŠŸèƒ½
4. ä¼˜åŒ–ä¸Šä¸‹æ–‡ç®¡ç†