# 知识库数据模型设计

## 🎯 目标
基于开发文档的ER关系图，设计知识库相关的数据模型和数据库表结构。

## 📋 前置条件
- PostgreSQL数据库已安装
- SQLAlchemy已配置

## 🗄️ 数据模型设计

### 1. 核心实体关系
```
KnowledgeBase (知识库) 1:N Document (文档) 1:N DocumentChunk (文档块) 1:1 VectorEmbedding (向量)
```

### 2. 创建数据模型文件

创建 `backend/app/models/knowledge.py`：
```python
from sqlalchemy import Column, String, Text, Integer, DateTime, ForeignKey, Enum
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
from datetime import datetime
import uuid
import enum
from .database import Base

class KnowledgeBaseStatus(str, enum.Enum):
    ACTIVE = "active"
    INACTIVE = "inactive" 
    DELETED = "deleted"

class DocumentStatus(str, enum.Enum):
    UPLOADED = "uploaded"
    PROCESSING = "processing"
    PROCESSED = "processed"
    FAILED = "failed"

class DocumentType(str, enum.Enum):
    PDF = "pdf"
    WORD = "word"
    TXT = "txt"
    MARKDOWN = "markdown"

class KnowledgeBase(Base):
    __tablename__ = "knowledge_bases"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = Column(String(100), nullable=False)
    description = Column(Text)
    owner_id = Column(UUID(as_uuid=True), nullable=False)
    status = Column(Enum(KnowledgeBaseStatus), default=KnowledgeBaseStatus.ACTIVE)
    document_count = Column(Integer, default=0)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # 关系
    documents = relationship("Document", back_populates="knowledge_base", cascade="all, delete-orphan")

class Document(Base):
    __tablename__ = "documents"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    knowledge_base_id = Column(UUID(as_uuid=True), ForeignKey("knowledge_bases.id"), nullable=False)
    title = Column(String(200), nullable=False)
    content = Column(Text)
    doc_type = Column(Enum(DocumentType), nullable=False)
    status = Column(Enum(DocumentStatus), default=DocumentStatus.UPLOADED)
    file_path = Column(String(500))
    file_size = Column(Integer)
    created_at = Column(DateTime, default=datetime.utcnow)
    processed_at = Column(DateTime)
    
    # 关系
    knowledge_base = relationship("KnowledgeBase", back_populates="documents")
    chunks = relationship("DocumentChunk", back_populates="document", cascade="all, delete-orphan")

class DocumentChunk(Base):
    __tablename__ = "document_chunks"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    document_id = Column(UUID(as_uuid=True), ForeignKey("documents.id"), nullable=False)
    content = Column(Text, nullable=False)
    chunk_index = Column(Integer, nullable=False)
    vector_id = Column(String(100))  # ChromaDB中的向量ID
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # 关系
    document = relationship("Document", back_populates="chunks")
```

### 3. 创建Pydantic模式

创建 `backend/app/schemas/knowledge.py`：
```python
from pydantic import BaseModel, Field
from typing import Optional, List
from datetime import datetime
from enum import Enum

class KnowledgeBaseStatus(str, Enum):
    ACTIVE = "active"
    INACTIVE = "inactive"
    DELETED = "deleted"

class DocumentStatus(str, Enum):
    UPLOADED = "uploaded"
    PROCESSING = "processing"
    PROCESSED = "processed"
    FAILED = "failed"

class DocumentType(str, Enum):
    PDF = "pdf"
    WORD = "word"
    TXT = "txt"
    MARKDOWN = "markdown"

# 知识库模式
class KnowledgeBaseCreate(BaseModel):
    name: str = Field(..., min_length=1, max_length=100)
    description: Optional[str] = None

class KnowledgeBaseUpdate(BaseModel):
    name: Optional[str] = Field(None, min_length=1, max_length=100)
    description: Optional[str] = None
    status: Optional[KnowledgeBaseStatus] = None

class KnowledgeBaseResponse(BaseModel):
    id: str
    name: str
    description: Optional[str]
    owner_id: str
    status: KnowledgeBaseStatus
    document_count: int
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True

# 文档模式
class DocumentResponse(BaseModel):
    id: str
    title: str
    doc_type: DocumentType
    status: DocumentStatus
    file_size: Optional[int]
    created_at: datetime
    processed_at: Optional[datetime]
    
    class Config:
        from_attributes = True
```

### 4. 数据库迁移脚本

创建 `backend/scripts/create_knowledge_tables.py`：
```python
from app.models.database import engine, Base
from app.models.knowledge import KnowledgeBase, Document, DocumentChunk

def create_knowledge_tables():
    """创建知识库相关表"""
    try:
        # 创建表
        Base.metadata.create_all(bind=engine, tables=[
            KnowledgeBase.__table__,
            Document.__table__,
            DocumentChunk.__table__
        ])
        print("✅ 知识库表创建成功")
        
        # 创建索引
        from sqlalchemy import text
        with engine.connect() as conn:
            # 知识库索引
            conn.execute(text("CREATE INDEX IF NOT EXISTS idx_kb_owner ON knowledge_bases(owner_id)"))
            conn.execute(text("CREATE INDEX IF NOT EXISTS idx_kb_status ON knowledge_bases(status)"))
            
            # 文档索引
            conn.execute(text("CREATE INDEX IF NOT EXISTS idx_doc_kb ON documents(knowledge_base_id)"))
            conn.execute(text("CREATE INDEX IF NOT EXISTS idx_doc_status ON documents(status)"))
            
            # 文档块索引
            conn.execute(text("CREATE INDEX IF NOT EXISTS idx_chunk_doc ON document_chunks(document_id)"))
            conn.execute(text("CREATE INDEX IF NOT EXISTS idx_chunk_vector ON document_chunks(vector_id)"))
            
            conn.commit()
        
        print("✅ 索引创建成功")
        
    except Exception as e:
        print(f"❌ 表创建失败: {e}")

if __name__ == "__main__":
    create_knowledge_tables()
```

## ✅ 验证步骤

### 1. 运行迁移脚本
```bash
cd backend
python scripts/create_knowledge_tables.py
```

### 2. 验证表结构
```sql
-- 连接PostgreSQL验证
\d knowledge_bases
\d documents  
\d document_chunks

-- 检查索引
\di
```

### 3. 测试数据插入
```python
# 测试脚本
from app.models.database import SessionLocal
from app.models.knowledge import KnowledgeBase
import uuid

db = SessionLocal()
try:
    kb = KnowledgeBase(
        name="测试知识库",
        description="这是一个测试知识库",
        owner_id=str(uuid.uuid4())
    )
    db.add(kb)
    db.commit()
    print(f"✅ 测试数据插入成功: {kb.id}")
finally:
    db.close()
```

## 🚨 常见问题

### UUID类型错误
```python
# 确保正确导入UUID类型
from sqlalchemy.dialects.postgresql import UUID
```

### 枚举类型问题
```python
# 确保枚举继承正确的基类
class DocumentStatus(str, enum.Enum):
    pass
```

### 外键约束错误
```sql
-- 检查外键约束
SELECT * FROM information_schema.table_constraints 
WHERE constraint_type = 'FOREIGN KEY';
```

## ➡️ 下一步
数据模型创建完成后，继续 [知识库API](./知识库API.md)