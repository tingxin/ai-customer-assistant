# 知识库管理功能测试

## 🎯 目标
验证知识库管理的所有功能是否按照产品文档的要求正常工作。

## 📋 测试范围
基于产品文档的管理端功能要求，测试以下功能：
- 知识库CRUD操作
- 文档上传和解析
- 向量化处理
- 智能检索
- 管理界面交互

## 🧪 测试用例

### 1. 知识库管理测试

#### 测试用例1.1：创建知识库
**测试步骤**：
1. 访问 http://localhost:3000/admin/knowledge
2. 点击"创建知识库"按钮
3. 输入知识库名称："测试知识库"
4. 输入描述："这是一个测试用的知识库"
5. 点击确定

**预期结果**：
- [ ] 模态框正常打开
- [ ] 表单验证正常工作
- [ ] 创建成功后显示成功消息
- [ ] 知识库列表自动刷新
- [ ] 新知识库出现在列表中

#### 测试用例1.2：编辑知识库
**测试步骤**：
1. 在知识库列表中点击"编辑"按钮
2. 修改知识库名称为："更新后的知识库"
3. 修改状态为"未激活"
4. 点击确定

**预期结果**：
- [ ] 编辑模态框正常打开并预填数据
- [ ] 更新成功后显示成功消息
- [ ] 列表中的数据已更新
- [ ] 状态标签颜色正确显示

#### 测试用例1.3：删除知识库
**测试步骤**：
1. 点击知识库的"删除"按钮
2. 在确认对话框中点击确定

**预期结果**：
- [ ] 确认对话框正常显示
- [ ] 删除成功后显示成功消息
- [ ] 知识库从列表中消失或状态变为"已删除"

### 2. 后端API测试

#### 测试用例2.1：API接口测试
创建测试脚本 `test_knowledge_api.py`：
```python
import requests
import json

BASE_URL = "http://localhost:8000/api/v1/knowledge"

def test_knowledge_base_crud():
    """测试知识库CRUD操作"""
    
    # 1. 创建知识库
    create_data = {
        "name": "API测试知识库",
        "description": "通过API创建的测试知识库"
    }
    
    response = requests.post(f"{BASE_URL}/bases", json=create_data)
    assert response.status_code == 201, f"创建失败: {response.text}"
    
    kb_data = response.json()
    kb_id = kb_data["id"]
    print(f"✅ 知识库创建成功: {kb_id}")
    
    # 2. 获取知识库列表
    response = requests.get(f"{BASE_URL}/bases")
    assert response.status_code == 200, f"获取列表失败: {response.text}"
    
    kbs = response.json()
    assert len(kbs) > 0, "知识库列表为空"
    print(f"✅ 知识库列表获取成功: {len(kbs)}个")
    
    # 3. 获取知识库详情
    response = requests.get(f"{BASE_URL}/bases/{kb_id}")
    assert response.status_code == 200, f"获取详情失败: {response.text}"
    
    kb_detail = response.json()
    assert kb_detail["name"] == create_data["name"], "知识库名称不匹配"
    print("✅ 知识库详情获取成功")
    
    # 4. 更新知识库
    update_data = {
        "name": "更新后的知识库",
        "description": "更新后的描述"
    }
    
    response = requests.put(f"{BASE_URL}/bases/{kb_id}", json=update_data)
    assert response.status_code == 200, f"更新失败: {response.text}"
    
    updated_kb = response.json()
    assert updated_kb["name"] == update_data["name"], "更新后名称不匹配"
    print("✅ 知识库更新成功")
    
    # 5. 删除知识库
    response = requests.delete(f"{BASE_URL}/bases/{kb_id}")
    assert response.status_code == 200, f"删除失败: {response.text}"
    print("✅ 知识库删除成功")
    
    # 6. 验证删除
    response = requests.get(f"{BASE_URL}/bases/{kb_id}")
    assert response.status_code == 404, "删除后仍能访问"
    print("✅ 删除验证成功")

if __name__ == "__main__":
    test_knowledge_base_crud()
    print("🎉 所有API测试通过")
```

运行测试：
```bash
cd backend
python test_knowledge_api.py
```

### 3. 文档处理测试

#### 测试用例3.1：文档上传测试
**测试步骤**：
1. 准备测试文件：
   ```bash
   # 创建测试文件
   echo "这是一个测试文档。包含产品功能介绍。" > test.txt
   echo "# 产品文档\n\n## 功能列表\n- 智能问答\n- 知识管理" > test.md
   ```

2. 在管理界面上传文件
3. 检查文档处理状态

**预期结果**：
- [ ] 文件上传成功
- [ ] 文档状态从"uploaded"变为"processing"再到"processed"
- [ ] 文档内容正确解析
- [ ] 向量化处理完成

#### 测试用例3.2：文档搜索测试
创建搜索测试脚本：
```python
import requests

def test_document_search():
    """测试文档搜索功能"""
    
    search_data = {
        "query": "产品功能",
        "top_k": 5
    }
    
    response = requests.post(
        "http://localhost:8000/api/v1/knowledge/search",
        json=search_data
    )
    
    assert response.status_code == 200, f"搜索失败: {response.text}"
    
    results = response.json()
    assert "results" in results, "搜索结果格式错误"
    
    search_results = results["results"]
    print(f"✅ 搜索到 {len(search_results)} 个结果")
    
    for i, result in enumerate(search_results):
        print(f"结果 {i+1}:")
        print(f"  相关度: {result.get('score', 0):.2f}")
        print(f"  内容: {result.get('content', '')[:100]}...")

if __name__ == "__main__":
    test_document_search()
```

### 4. 集成测试

#### 测试用例4.1：完整流程测试
**测试步骤**：
1. 创建知识库
2. 上传多个不同格式的文档
3. 等待文档处理完成
4. 在聊天界面测试知识检索
5. 验证AI回复的准确性

**自动化测试脚本**：
```bash
#!/bin/bash
echo "=== 知识库管理集成测试 ==="

# 1. 检查服务状态
echo "检查后端服务..."
if curl -s http://localhost:8000/health | grep -q "healthy"; then
    echo "✅ 后端服务正常"
else
    echo "❌ 后端服务异常"
    exit 1
fi

echo "检查前端服务..."
if curl -s http://localhost:3000 | grep -q "html"; then
    echo "✅ 前端服务正常"
else
    echo "❌ 前端服务异常"
    exit 1
fi

# 2. 测试API接口
echo "测试知识库API..."
python test_knowledge_api.py

# 3. 测试文档搜索
echo "测试文档搜索..."
python test_document_search.py

echo "🎉 集成测试完成"
```

## 📊 性能测试

### 并发测试
```python
import asyncio
import aiohttp
import time

async def concurrent_requests():
    """并发请求测试"""
    async with aiohttp.ClientSession() as session:
        tasks = []
        start_time = time.time()
        
        # 创建100个并发请求
        for i in range(100):
            task = session.get("http://localhost:8000/api/v1/knowledge/bases")
            tasks.append(task)
        
        responses = await asyncio.gather(*tasks)
        end_time = time.time()
        
        success_count = sum(1 for r in responses if r.status == 200)
        print(f"并发测试结果: {success_count}/100 成功")
        print(f"总耗时: {end_time - start_time:.2f}秒")

asyncio.run(concurrent_requests())
```

## 🚨 故障排除

### 数据库连接问题
```bash
# 检查PostgreSQL状态
docker compose ps postgres

# 测试数据库连接
python -c "from app.models.database import engine; print(engine.execute('SELECT 1').scalar())"
```

### 向量服务问题
```bash
# 检查ChromaDB状态
curl http://localhost:8001/api/v1/heartbeat

# 测试向量服务
python -c "import chromadb; client = chromadb.Client(); print('ChromaDB连接成功')"
```

### 文件上传问题
```bash
# 检查上传目录权限
ls -la data/uploads/
chmod 755 data/uploads/
```

## 📈 测试报告模板

```markdown
# 知识库管理功能测试报告

## 测试环境
- 操作系统: 
- Python版本: 
- Node.js版本: 
- 数据库版本: 

## 测试结果
- [ ] 知识库CRUD: 通过/失败
- [ ] 文档上传: 通过/失败  
- [ ] 文档解析: 通过/失败
- [ ] 向量化处理: 通过/失败
- [ ] 智能检索: 通过/失败
- [ ] 管理界面: 通过/失败

## 性能指标
- API响应时间: 
- 文档处理速度: 
- 并发处理能力: 

## 问题记录
1. 问题描述
   - 解决方案
   - 状态: 已解决/待解决
```

## ✅ 验收标准

所有测试用例通过后，知识库管理功能应该满足：
- [ ] 功能完整性：所有CRUD操作正常
- [ ] 数据一致性：数据库和界面数据同步
- [ ] 性能要求：API响应时间 < 2秒
- [ ] 错误处理：异常情况有友好提示
- [ ] 用户体验：界面操作流畅直观

## 🎉 测试完成
所有测试通过后，知识库管理功能实施完成，可以进入下一个模块的开发。