# 知识库管理界面实现

## 🎯 目标
基于开发文档的管理端模块设计，使用Ant Design实现知识库管理的前端界面。

## 📋 前置条件
- 知识库API已实现并正常运行
- React项目已创建

## 🎨 管理界面实现

### 1. 安装Ant Design依赖

```bash
cd frontend
npm install antd @ant-design/icons
npm install react-router-dom @types/react-router-dom
npm install react-dropzone
```

### 2. 创建知识库服务

创建 `frontend/src/services/knowledgeService.ts`：
```typescript
import axios from 'axios';

const API_BASE_URL = process.env.REACT_APP_API_URL || 'http://localhost:8000/api/v1';

const apiClient = axios.create({
  baseURL: API_BASE_URL,
  timeout: 30000,
});

export interface KnowledgeBase {
  id: string;
  name: string;
  description?: string;
  owner_id: string;
  status: 'active' | 'inactive' | 'deleted';
  document_count: number;
  created_at: string;
  updated_at: string;
}

export interface CreateKnowledgeBaseRequest {
  name: string;
  description?: string;
}

export interface UpdateKnowledgeBaseRequest {
  name?: string;
  description?: string;
  status?: 'active' | 'inactive';
}

export class KnowledgeBaseService {
  static async getKnowledgeBases(): Promise<KnowledgeBase[]> {
    const response = await apiClient.get('/knowledge/bases');
    return response.data;
  }

  static async createKnowledgeBase(data: CreateKnowledgeBaseRequest): Promise<KnowledgeBase> {
    const response = await apiClient.post('/knowledge/bases', data);
    return response.data;
  }

  static async updateKnowledgeBase(id: string, data: UpdateKnowledgeBaseRequest): Promise<KnowledgeBase> {
    const response = await apiClient.put(`/knowledge/bases/${id}`, data);
    return response.data;
  }

  static async deleteKnowledgeBase(id: string, hardDelete: boolean = false): Promise<void> {
    await apiClient.delete(`/knowledge/bases/${id}?hard_delete=${hardDelete}`);
  }

  static async uploadDocument(kbId: string, file: File, docType: string): Promise<any> {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('doc_type', docType);

    const response = await apiClient.post(`/knowledge/bases/${kbId}/documents/upload`, formData, {
      headers: {
        'Content-Type': 'multipart/form-data',
      },
    });
    return response.data;
  }
}
```

### 3. 创建知识库列表页面

创建 `frontend/src/pages/admin/KnowledgeBaseList.tsx`：
```tsx
import React, { useState, useEffect } from 'react';
import {
  Layout,
  Card,
  Button,
  Table,
  Modal,
  Form,
  Input,
  Select,
  message,
  Tag,
  Space,
  Popconfirm,
  Typography
} from 'antd';
import {
  PlusOutlined,
  EditOutlined,
  DeleteOutlined,
  FolderOutlined,
  InfoCircleOutlined
} from '@ant-design/icons';
import { KnowledgeBaseService, KnowledgeBase, CreateKnowledgeBaseRequest } from '../../services/knowledgeService';

const { Header, Content } = Layout;
const { Title } = Typography;
const { TextArea } = Input;

const KnowledgeBaseList: React.FC = () => {
  const [knowledgeBases, setKnowledgeBases] = useState<KnowledgeBase[]>([]);
  const [loading, setLoading] = useState(false);
  const [createModalVisible, setCreateModalVisible] = useState(false);
  const [editModalVisible, setEditModalVisible] = useState(false);
  const [currentKB, setCurrentKB] = useState<KnowledgeBase | null>(null);
  const [createForm] = Form.useForm();
  const [editForm] = Form.useForm();

  useEffect(() => {
    loadKnowledgeBases();
  }, []);

  const loadKnowledgeBases = async () => {
    setLoading(true);
    try {
      const data = await KnowledgeBaseService.getKnowledgeBases();
      setKnowledgeBases(data);
    } catch (error) {
      message.error('加载知识库失败');
    } finally {
      setLoading(false);
    }
  };

  const handleCreateKnowledgeBase = async (values: CreateKnowledgeBaseRequest) => {
    try {
      await KnowledgeBaseService.createKnowledgeBase(values);
      message.success('知识库创建成功');
      setCreateModalVisible(false);
      createForm.resetFields();
      loadKnowledgeBases();
    } catch (error) {
      message.error('创建知识库失败');
    }
  };

  const handleEditKnowledgeBase = async (values: any) => {
    if (!currentKB) return;
    
    try {
      await KnowledgeBaseService.updateKnowledgeBase(currentKB.id, values);
      message.success('知识库更新成功');
      setEditModalVisible(false);
      setCurrentKB(null);
      editForm.resetFields();
      loadKnowledgeBases();
    } catch (error) {
      message.error('更新知识库失败');
    }
  };

  const handleDeleteKnowledgeBase = async (id: string, hardDelete: boolean = false) => {
    try {
      await KnowledgeBaseService.deleteKnowledgeBase(id, hardDelete);
      message.success(hardDelete ? '知识库已永久删除' : '知识库已删除');
      loadKnowledgeBases();
    } catch (error) {
      message.error('删除知识库失败');
    }
  };

  const showEditModal = (kb: KnowledgeBase) => {
    setCurrentKB(kb);
    editForm.setFieldsValue({
      name: kb.name,
      description: kb.description,
      status: kb.status
    });
    setEditModalVisible(true);
  };

  const columns = [
    {
      title: '知识库名称',
      dataIndex: 'name',
      key: 'name',
      render: (name: string, record: KnowledgeBase) => (
        <Space>
          <FolderOutlined />
          <strong>{name}</strong>
        </Space>
      ),
    },
    {
      title: '描述',
      dataIndex: 'description',
      key: 'description',
      ellipsis: true,
      render: (desc: string) => desc || '-',
    },
    {
      title: '状态',
      dataIndex: 'status',
      key: 'status',
      render: (status: string) => {
        const colors = {
          'active': 'green',
          'inactive': 'orange',
          'deleted': 'red'
        };
        const labels = {
          'active': '活跃',
          'inactive': '未激活',
          'deleted': '已删除'
        };
        return <Tag color={colors[status as keyof typeof colors]}>{labels[status as keyof typeof labels]}</Tag>;
      },
    },
    {
      title: '文档数量',
      dataIndex: 'document_count',
      key: 'document_count',
      render: (count: number) => count || 0,
    },
    {
      title: '创建时间',
      dataIndex: 'created_at',
      key: 'created_at',
      render: (date: string) => new Date(date).toLocaleString(),
    },
    {
      title: '操作',
      key: 'actions',
      render: (record: KnowledgeBase) => (
        <Space>
          <Button 
            icon={<EditOutlined />} 
            size="small"
            onClick={() => showEditModal(record)}
          >
            编辑
          </Button>
          <Button 
            icon={<InfoCircleOutlined />} 
            size="small"
            onClick={() => {/* 显示统计信息 */}}
          >
            统计
          </Button>
          <Popconfirm
            title="确定要删除这个知识库吗？"
            description="删除后可以在回收站中恢复"
            onConfirm={() => handleDeleteKnowledgeBase(record.id, false)}
          >
            <Button danger icon={<DeleteOutlined />} size="small">
              删除
            </Button>
          </Popconfirm>
        </Space>
      ),
    },
  ];

  return (
    <Layout style={{ minHeight: '100vh', background: '#f0f2f5' }}>
      <Header style={{ background: '#fff', padding: '0 24px', boxShadow: '0 1px 4px rgba(0,21,41,.08)' }}>
        <Title level={3} style={{ margin: 0, lineHeight: '64px' }}>知识库管理</Title>
      </Header>
      <Content style={{ margin: '24px' }}>
        <Card>
          <div style={{ marginBottom: 16 }}>
            <Button 
              type="primary" 
              icon={<PlusOutlined />}
              onClick={() => setCreateModalVisible(true)}
              size="large"
            >
              创建知识库
            </Button>
          </div>
          
          <Table
            columns={columns}
            dataSource={knowledgeBases}
            loading={loading}
            rowKey="id"
            pagination={{
              showSizeChanger: true,
              showQuickJumper: true,
              showTotal: (total) => `共 ${total} 个知识库`,
            }}
          />
        </Card>

        {/* 创建知识库模态框 */}
        <Modal
          title="创建知识库"
          open={createModalVisible}
          onCancel={() => setCreateModalVisible(false)}
          onOk={() => createForm.submit()}
          width={600}
        >
          <Form
            form={createForm}
            layout="vertical"
            onFinish={handleCreateKnowledgeBase}
          >
            <Form.Item
              name="name"
              label="知识库名称"
              rules={[
                { required: true, message: '请输入知识库名称' },
                { min: 2, max: 50, message: '名称长度应在2-50字符之间' }
              ]}
            >
              <Input placeholder="输入知识库名称" />
            </Form.Item>
            <Form.Item
              name="description"
              label="描述"
              rules={[
                { max: 200, message: '描述不能超过200字符' }
              ]}
            >
              <TextArea 
                placeholder="输入知识库描述（可选）" 
                rows={4}
                showCount
                maxLength={200}
              />
            </Form.Item>
          </Form>
        </Modal>

        {/* 编辑知识库模态框 */}
        <Modal
          title="编辑知识库"
          open={editModalVisible}
          onCancel={() => setEditModalVisible(false)}
          onOk={() => editForm.submit()}
          width={600}
        >
          <Form
            form={editForm}
            layout="vertical"
            onFinish={handleEditKnowledgeBase}
          >
            <Form.Item
              name="name"
              label="知识库名称"
              rules={[
                { required: true, message: '请输入知识库名称' },
                { min: 2, max: 50, message: '名称长度应在2-50字符之间' }
              ]}
            >
              <Input placeholder="输入知识库名称" />
            </Form.Item>
            <Form.Item
              name="description"
              label="描述"
              rules={[
                { max: 200, message: '描述不能超过200字符' }
              ]}
            >
              <TextArea 
                placeholder="输入知识库描述（可选）" 
                rows={4}
                showCount
                maxLength={200}
              />
            </Form.Item>
            <Form.Item
              name="status"
              label="状态"
            >
              <Select>
                <Select.Option value="active">活跃</Select.Option>
                <Select.Option value="inactive">未激活</Select.Option>
              </Select>
            </Form.Item>
          </Form>
        </Modal>
      </Content>
    </Layout>
  );
};

export default KnowledgeBaseList;
```

### 4. 创建文档管理页面

创建 `frontend/src/pages/admin/DocumentManagement.tsx`：
```tsx
import React, { useState } from 'react';
import { Layout, Card, Upload, Button, message, Select, Form } from 'antd';
import { UploadOutlined, InboxOutlined } from '@ant-design/icons';
import { useDropzone } from 'react-dropzone';
import { KnowledgeBaseService } from '../../services/knowledgeService';

const { Content } = Layout;
const { Dragger } = Upload;

interface DocumentManagementProps {
  knowledgeBaseId: string;
}

const DocumentManagement: React.FC<DocumentManagementProps> = ({ knowledgeBaseId }) => {
  const [uploading, setUploading] = useState(false);
  const [form] = Form.useForm();

  const handleFileUpload = async (file: File, docType: string) => {
    setUploading(true);
    try {
      await KnowledgeBaseService.uploadDocument(knowledgeBaseId, file, docType);
      message.success(`文档 ${file.name} 上传成功`);
    } catch (error) {
      message.error(`文档 ${file.name} 上传失败`);
    } finally {
      setUploading(false);
    }
  };

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    accept: {
      'application/pdf': ['.pdf'],
      'application/msword': ['.doc'],
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
      'text/plain': ['.txt'],
      'text/markdown': ['.md']
    },
    onDrop: (acceptedFiles) => {
      acceptedFiles.forEach(file => {
        const docType = getDocTypeFromFile(file);
        handleFileUpload(file, docType);
      });
    }
  });

  const getDocTypeFromFile = (file: File): string => {
    const extension = file.name.split('.').pop()?.toLowerCase();
    switch (extension) {
      case 'pdf': return 'pdf';
      case 'doc':
      case 'docx': return 'word';
      case 'txt': return 'txt';
      case 'md': return 'markdown';
      default: return 'txt';
    }
  };

  return (
    <Layout style={{ minHeight: '100vh', background: '#f0f2f5' }}>
      <Content style={{ margin: '24px' }}>
        <Card title="文档上传">
          <div 
            {...getRootProps()} 
            style={{
              border: '2px dashed #d9d9d9',
              borderRadius: '6px',
              padding: '40px',
              textAlign: 'center',
              cursor: 'pointer',
              backgroundColor: isDragActive ? '#f0f0f0' : '#fafafa'
            }}
          >
            <input {...getInputProps()} />
            <InboxOutlined style={{ fontSize: '48px', color: '#d9d9d9' }} />
            <p style={{ marginTop: '16px', fontSize: '16px' }}>
              {isDragActive ? '释放文件到此处' : '拖拽文件到此处，或点击选择文件'}
            </p>
            <p style={{ color: '#999' }}>
              支持 PDF, Word, TXT, Markdown 格式
            </p>
          </div>
          
          {uploading && (
            <div style={{ marginTop: '16px', textAlign: 'center' }}>
              <span>正在上传文档...</span>
            </div>
          )}
        </Card>
      </Content>
    </Layout>
  );
};

export default DocumentManagement;
```

### 5. 更新主应用路由

更新 `frontend/src/App.tsx`：
```tsx
import React from 'react';
import { BrowserRouter as Router, Routes, Route, Link } from 'react-router-dom';
import Chat, { useMessages } from '@chatui/core';
import '@chatui/core/dist/index.css';
import KnowledgeBaseList from './pages/admin/KnowledgeBaseList';
import { Button } from 'antd';
import { SettingOutlined } from '@ant-design/icons';

const App: React.FC = () => {
  const { messages, appendMsg, setTyping } = useMessages([]);

  const handleSend = async (type: string, val: string) => {
    // 聊天逻辑保持不变
  };

  return (
    <Router>
      <Routes>
        <Route path="/" element={
          <div style={{ height: '100vh' }}>
            <Chat
              navbar={{ 
                title: '智能客服',
                rightContent: (
                  <Link to="/admin/knowledge">
                    <Button 
                      type="text" 
                      icon={<SettingOutlined />}
                      style={{ color: '#fff' }}
                    >
                      管理
                    </Button>
                  </Link>
                )
              }}
              messages={messages}
              onSend={handleSend}
              placeholder="请输入您的问题..."
            />
          </div>
        } />
        <Route path="/admin/knowledge" element={<KnowledgeBaseList />} />
      </Routes>
    </Router>
  );
};

export default App;
```

## ✅ 验证步骤

### 1. 启动前端服务
```bash
cd frontend
npm start
```

### 2. 测试管理界面
- [ ] 访问 http://localhost:3000/admin/knowledge
- [ ] 知识库列表正常显示
- [ ] 创建知识库功能正常
- [ ] 编辑知识库功能正常
- [ ] 删除知识库功能正常

### 3. 测试文档上传
- [ ] 拖拽文件上传功能正常
- [ ] 支持的文件格式正确识别
- [ ] 上传进度显示正常
- [ ] 上传成功/失败消息正确显示

### 4. 测试界面交互
- [ ] 表格排序和分页正常
- [ ] 模态框打开和关闭正常
- [ ] 表单验证正常工作
- [ ] 响应式布局适配正常

## 🚨 常见问题

### Ant Design样式问题
```tsx
// 确保正确导入Ant Design样式
import 'antd/dist/reset.css';
```

### 路由配置问题
```tsx
// 确保BrowserRouter正确配置
import { BrowserRouter as Router } from 'react-router-dom';
```

### 文件上传问题
```typescript
// 检查文件类型和大小限制
const isValidFile = (file: File) => {
  const validTypes = ['pdf', 'doc', 'docx', 'txt', 'md'];
  const extension = file.name.split('.').pop()?.toLowerCase();
  return validTypes.includes(extension || '');
};
```

## ➡️ 下一步
管理界面完成后，继续 [功能测试](./功能测试.md)