# 前端聊天界面实施

## 🎯 目标
使用阿里ChatUI实现专业的聊天界面，支持消息收发、富文本渲染和用户交互。

## 📋 前置条件
- Node.js 18+ 已安装
- 项目目录结构已创建

## 🔧 实施步骤

### 1. 创建React项目
```bash
cd frontend
npx create-react-app . --template typescript
```

### 2. 安装ChatUI依赖
```bash
# 安装阿里ChatUI
npm install @chatui/core

# 安装富文本渲染依赖
npm install react-markdown react-syntax-highlighter
npm install remark-math rehype-katex katex

# 安装类型定义
npm install --save-dev @types/react-syntax-highlighter

# 安装HTTP客户端
npm install axios
```

### 3. 创建聊天服务
创建 `src/services/chatService.ts`：
```typescript
import axios from 'axios';

const API_BASE_URL = process.env.REACT_APP_API_URL || 'http://localhost:8000/api/v1';

const apiClient = axios.create({
  baseURL: API_BASE_URL,
  timeout: 10000,
});

export interface SessionResponse {
  session_id: string;
  expires_at: string;
}

export interface MessageResponse {
  content: string;
  message_id: string;
  timestamp: string;
}

export class ChatService {
  static async initSession(): Promise<SessionResponse> {
    const response = await apiClient.post('/chat/sessions');
    return response.data.data;
  }

  static async sendMessage(sessionId: string, message: string): Promise<MessageResponse> {
    const response = await apiClient.post('/chat/messages', {
      session_id: sessionId,
      message: message,
    });
    return response.data.data;
  }

  static async getSessionHistory(sessionId: string) {
    const response = await apiClient.get(`/chat/sessions/${sessionId}/messages`);
    return response.data.data;
  }
}
```

### 4. 创建富文本渲染组件
创建 `src/components/RichTextRenderer.tsx`：
```tsx
import React from 'react';
import ReactMarkdown from 'react-markdown';
import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';
import { tomorrow } from 'react-syntax-highlighter/dist/esm/styles/prism';
import remarkMath from 'remark-math';
import rehypeKatex from 'rehype-katex';
import 'katex/dist/katex.min.css';

interface RichTextRendererProps {
  content: string;
}

const RichTextRenderer: React.FC<RichTextRendererProps> = ({ content }) => {
  const components = {
    code({ node, inline, className, children, ...props }: any) {
      const match = /language-(\w+)/.exec(className || '');
      return !inline && match ? (
        <SyntaxHighlighter
          style={tomorrow}
          language={match[1]}
          PreTag="div"
          {...props}
        >
          {String(children).replace(/\n$/, '')}
        </SyntaxHighlighter>
      ) : (
        <code className={className} {...props}>
          {children}
        </code>
      );
    },
    
    table: ({ children }: any) => (
      <div className="table-container">
        <table className="rich-table">{children}</table>
      </div>
    ),
    
    a: ({ href, children }: any) => (
      <a 
        href={href} 
        target="_blank" 
        rel="noopener noreferrer"
        className="rich-link"
      >
        {children}
      </a>
    )
  };

  return (
    <div className="rich-content">
      <ReactMarkdown
        components={components}
        remarkPlugins={[remarkMath]}
        rehypePlugins={[rehypeKatex]}
      >
        {content}
      </ReactMarkdown>
    </div>
  );
};

export default RichTextRenderer;
```

### 5. 创建主聊天组件
创建 `src/App.tsx`：
```tsx
import React, { useState, useEffect } from 'react';
import Chat, { Bubble, useMessages } from '@chatui/core';
import '@chatui/core/dist/index.css';
import { ChatService } from './services/chatService';
import RichTextRenderer from './components/RichTextRenderer';
import './App.css';

const App: React.FC = () => {
  const { messages, appendMsg, setTyping } = useMessages([]);
  const [sessionId, setSessionId] = useState<string>('');

  useEffect(() => {
    initializeSession();
  }, []);

  const initializeSession = async () => {
    try {
      const session = await ChatService.initSession();
      setSessionId(session.session_id);
      
      // 添加欢迎消息
      appendMsg({
        type: 'text',
        content: { text: '您好！我是智能客服助手 🤖\n\n我可以帮您解答各种问题，请告诉我您想了解什么？' },
        user: { avatar: '🤖' },
      });
    } catch (error) {
      console.error('Failed to initialize session:', error);
    }
  };

  const handleSend = async (type: string, val: string) => {
    if (type === 'text' && val.trim()) {
      // 添加用户消息
      appendMsg({
        type: 'text',
        content: { text: val },
        position: 'right',
      });

      setTyping(true);

      try {
        const response = await ChatService.sendMessage(sessionId, val);
        appendMsg({
          type: 'text',
          content: { text: response.content },
          user: { avatar: '🤖' },
        });
      } catch (error) {
        appendMsg({
          type: 'text',
          content: { text: '抱歉，服务暂时不可用，请稍后再试。' },
          user: { avatar: '🤖' },
        });
      } finally {
        setTyping(false);
      }
    }
  };

  const renderMessageContent = (msg: any) => {
    const { content } = msg;
    
    if (msg.user?.avatar === '🤖') {
      return (
        <div className="ai-message">
          <RichTextRenderer content={content.text} />
        </div>
      );
    }
    
    return <Bubble content={content.text} />;
  };

  return (
    <div style={{ height: '100vh' }}>
      <Chat
        navbar={{ 
          title: '智能客服',
          rightContent: (
            <div style={{ fontSize: '12px', color: '#52c41a' }}>
              ● 在线
            </div>
          )
        }}
        messages={messages}
        renderMessageContent={renderMessageContent}
        onSend={handleSend}
        placeholder="请输入您的问题..."
        quickReplies={[
          { name: '产品功能', isNew: true, isHighlight: false },
          { name: '使用方法', isNew: false, isHighlight: false },
          { name: '技术支持', isNew: false, isHighlight: false },
          { name: '常见问题', isNew: false, isHighlight: false },
        ]}
        onQuickReplyClick={(item) => handleSend('text', item.name)}
      />
    </div>
  );
};

export default App;
```

### 6. 添加样式文件
创建 `src/App.css`：
```css
.ai-message {
  max-width: 100%;
}

.rich-content {
  line-height: 1.6;
  color: #333;
}

.rich-content h1, .rich-content h2, .rich-content h3 {
  margin: 16px 0 8px 0;
  font-weight: 600;
}

.rich-content h1 { font-size: 20px; }
.rich-content h2 { font-size: 18px; }
.rich-content h3 { font-size: 16px; }

.rich-content p {
  margin: 8px 0;
}

.rich-content ul, .rich-content ol {
  margin: 8px 0;
  padding-left: 20px;
}

.rich-content code {
  background: #f1f3f4;
  padding: 2px 4px;
  border-radius: 3px;
  font-family: 'Monaco', 'Consolas', monospace;
  font-size: 0.9em;
}

.rich-table {
  width: 100%;
  border-collapse: collapse;
  margin: 12px 0;
  font-size: 14px;
}

.rich-table th,
.rich-table td {
  border: 1px solid #e0e0e0;
  padding: 6px 10px;
  text-align: left;
}

.rich-table th {
  background: #f8f9fa;
  font-weight: 600;
}

.rich-link {
  color: #007bff;
  text-decoration: none;
}

.rich-link:hover {
  text-decoration: underline;
}

.table-container {
  overflow-x: auto;
}
```

### 7. 配置环境变量
创建 `frontend/.env`：
```
REACT_APP_API_URL=http://localhost:8000/api/v1
```

## ✅ 验证步骤

### 1. 启动前端服务
```bash
cd frontend
npm start
```

### 2. 检查界面
- [ ] 浏览器自动打开 http://localhost:3000
- [ ] ChatUI界面正常显示
- [ ] 导航栏显示"智能客服"和在线状态
- [ ] 输入框和快速回复按钮可见

### 3. 测试基础功能
- [ ] 输入框可以输入文字
- [ ] 快速回复按钮可以点击
- [ ] 消息气泡样式正确
- [ ] 欢迎消息正常显示

### 4. 检查控制台
- [ ] 无JavaScript错误
- [ ] 网络请求正常（可能会有API连接错误，这是正常的）

## 🚨 常见问题

### 依赖安装失败
```bash
# 清理缓存重新安装
rm -rf node_modules package-lock.json
npm install
```

### ChatUI样式问题
```bash
# 确保CSS文件正确导入
import '@chatui/core/dist/index.css';
```

### TypeScript错误
```bash
# 检查类型定义是否正确安装
npm install --save-dev @types/react @types/react-dom
```

## ➡️ 下一步
前端界面完成后，继续 [后端聊天API](./后端聊天API.md)